#!/bin/sh

set -ex

MAKEOBJDIRPREFIX=${WORKSPACE}/obj
rm -fr ${MAKEOBJDIRPREFIX}


MAKECONF=${MAKECONF:-/dev/null}
SRCCONF=${SRCCONF:-/dev/null}

if [ -n "${CROSS_TOOLCHAIN}" ]; then
	CROSS_TOOLCHAIN_PARAM=CROSS_TOOLCHAIN=${CROSS_TOOLCHAIN}
fi

OUTPUT_IMG=${WORKSPACE}/disk-test.img
sudo env MAKEOBJDIRPREFIX=${MAKEOBJDIRPREFIX} make \
	-C /usr/src/tests/ci \
	ci-buildimage-${TARGET_ARCH} \
	TARGET=${TARGET} \
	TARGET_ARCH=${TARGET_ARCH} \
	${CROSS_TOOLCHAIN_PARAM} \
	__MAKE_CONF=${MAKECONF} \
	MAKECONF=${MAKECONF} \
	SRCCONF=${SRCCONF} \
	SRC_ENV_CONF=/dev/null \
	METAMODE= \
	CITYPE=full \
	CIENV=jenkins \
	CIDISK=${OUTPUT_IMG} \
	PARALLEL_JOBS=${JFLAG}

ARTIFACT_DEST=artifact/${FBSD_BRANCH}/${GIT_COMMIT}/${TARGET}/${TARGET_ARCH}
sudo mkdir -p ${ARTIFACT_DEST}
sudo mv ${OUTPUT_IMG} ${ARTIFACT_DEST}

echo "${GIT_COMMIT}" | sudo tee ${ARTIFACT_DEST}/revision.txt

echo "USE_GIT_COMMIT=${GIT_COMMIT}" > ${WORKSPACE}/trigger.property
