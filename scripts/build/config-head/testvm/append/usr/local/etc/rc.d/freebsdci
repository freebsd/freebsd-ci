#!/bin/sh

# SPDX-License-Identifier: BSD-2-Clause
#
# Copyright (c) 2024 The FreeBSD Foundation
#
# This software was developed by Cybermancer Infosec <bofh@FreeBSD.org>
# under sponsorship from the FreeBSD Foundation.
#
# PROVIDE: freebsdci
# REQUIRE: LOGIN FILESYSTEMS
# KEYWORD: firstboot

# This script is used to run the firstboot CI tests on the first boot of a
# FreeBSD image. It is automatically disabled after the first boot.
#
# The script will run the firstboot CI tests and then shut down the system.
# The tests are run in the foreground so that the system can shut down
# immediately after the tests are finished.

name="freebsdci"
desc="Run FreeBSD CI"
rcvar=freebsdci_enable
start_cmd="firstboot_ci_run"
stop_cmd=":"
METADIR=/meta

load_rc_config $name
: ${freebsdci_enable:="NO"}

PATH="${PATH}:/usr/local/sbin:/usr/local/bin"

firstboot_ci_run()
{
	echo
	echo "--------------------------------------------------------------"
	echo "freebsdci start!"
	echo "--------------------------------------------------------------"

	set -x
	ddb script kdb.enter.panic="show pcpu; reset"

	for TARDEV in /dev/vtbd0 /dev/vtbd1 /dev/ada0 /dev/ada1; do
	        ISTAR=$(file -s ${TARDEV} | grep "POSIX tar archive" | wc -l)
	        if [ ${ISTAR} -eq 1 ]; then
	                break
	        fi
	done

	if [ ${ISTAR} -eq 1 ]; then
	        rm -fr ${METADIR}
	        mkdir -p ${METADIR}
	        tar xvf ${TARDEV} -C ${METADIR}
	        sh -ex ${METADIR}/run.sh
	        tar cvf ${TARDEV} -C ${METADIR} .
	else
		echo "ERROR: no device with POSIX tar archive format found."
		# Don't shutdown because this is not run in unattended mode
		exit 1
	fi

	if [ -f ${METADIR}/auto-shutdown ]; then
		# XXX: Currently RISC-V and MIPS64 kernels lack the ability
		#      to make qemu exit on shutdown.  Reboot instead;
		#      it makes qemu exit too.
		case "$(uname -p)" in
			mips64|riscv64)
				shutdown -r now
				;;
			*)
				shutdown -p now
				;;
		esac
	fi
}

run_rc_command "$1"
